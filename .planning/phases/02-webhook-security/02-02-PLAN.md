---
phase: 02-webhook-security
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - lib/webhook-security/idempotency.ts
  - app/api/webhooks/stripe/route.ts
  - tests/api/webhooks/stripe/security.test.ts
  - supabase/migrations/YYYYMMDDHHMMSS_add_processed_webhook_events.sql
autonomous: true

must_haves:
  truths:
    - "Webhook payloads are validated with Zod before type casting"
    - "Duplicate webhook events are detected and skipped"
    - "Invalid signatures are rejected with appropriate logging"
    - "Malformed payloads are rejected before reaching business logic"
  artifacts:
    - path: "lib/webhook-security/idempotency.ts"
      provides: "Webhook event deduplication utilities"
      exports: ["isEventProcessed", "markEventProcessed"]
    - path: "app/api/webhooks/stripe/route.ts"
      provides: "Secure webhook handler with validation"
      contains: "safeParse"
    - path: "tests/api/webhooks/stripe/security.test.ts"
      provides: "Security tests for webhook handler"
      min_lines: 80
    - path: "supabase/migrations/*_add_processed_webhook_events.sql"
      provides: "Idempotency tracking table"
      contains: "processed_webhook_events"
  key_links:
    - from: "app/api/webhooks/stripe/route.ts"
      to: "app/api/webhooks/stripe/schemas.ts"
      via: "schema import and safeParse"
      pattern: "import.*schemas"
    - from: "app/api/webhooks/stripe/route.ts"
      to: "lib/webhook-security/idempotency.ts"
      via: "idempotency check"
      pattern: "isEventProcessed"
---

<objective>
Integrate Zod validation and idempotency checking into the Stripe webhook handler, completing SEC-03 (payload validation) and adding protection against duplicate processing.

Purpose: The current webhook handler uses unsafe type assertions (`as Stripe.Subscription`) that could crash on malformed payloads. This plan applies the schemas from Plan 01, adds idempotency tracking to prevent duplicate processing from Stripe retries, and validates the security improvements with comprehensive tests.

Output: Fully secured webhook handler with Zod validation, idempotency, and security test coverage.
</objective>

<execution_context>
@/Users/Vignesh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Vignesh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-webhook-security/02-RESEARCH.md

# Will be created by Plan 01
@app/api/webhooks/stripe/schemas.ts
@lib/webhook-security/hmac.ts

# Current implementation to refactor
@app/api/webhooks/stripe/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create idempotency infrastructure</name>
  <files>lib/webhook-security/idempotency.ts, supabase/migrations/YYYYMMDDHHMMSS_add_processed_webhook_events.sql</files>
  <action>
Create Supabase migration for processed_webhook_events table:
```sql
CREATE TABLE processed_webhook_events (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  event_id TEXT UNIQUE NOT NULL,
  event_type TEXT NOT NULL,
  processed_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Index for fast lookups
CREATE INDEX idx_processed_webhook_events_event_id ON processed_webhook_events(event_id);

-- Index for cleanup queries (events older than 7 days can be deleted)
CREATE INDEX idx_processed_webhook_events_processed_at ON processed_webhook_events(processed_at);

-- RLS: Only service role can access (webhooks use service role key)
ALTER TABLE processed_webhook_events ENABLE ROW LEVEL SECURITY;
```

Run migration:
```bash
npx supabase db push
```
OR create local migration file with timestamp naming.

Create lib/webhook-security/idempotency.ts:
- Export `isEventProcessed(eventId: string): Promise<boolean>` - checks if event exists
- Export `markEventProcessed(eventId: string, eventType: string, metadata?: Record<string, unknown>): Promise<void>` - inserts record
- Use server-side Supabase client with service role
- Handle database errors gracefully (fail-open for idempotency check - allow processing if DB unreachable, but log warning)
- Add JSDoc explaining the 7-day retention rationale (Stripe retries for up to 3 days)
  </action>
  <verify>
```bash
# Verify migration exists
ls supabase/migrations/*processed_webhook_events*

# Verify idempotency module compiles
npx tsc --noEmit lib/webhook-security/idempotency.ts
```
  </verify>
  <done>
Database table exists for tracking processed events. Idempotency utilities exported and compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor webhook handler with Zod validation and idempotency</name>
  <files>app/api/webhooks/stripe/route.ts</files>
  <action>
Refactor the POST handler to:

1. KEEP existing signature verification (constructEvent) - it's already timing-safe

2. ADD idempotency check AFTER signature verification:
```typescript
if (await isEventProcessed(event.id)) {
  console.log(`Event ${event.id} already processed, skipping`);
  return NextResponse.json({ received: true });
}
```

3. REPLACE all `event.data.object as Stripe.X` with Zod validation:
```typescript
// Before (UNSAFE):
const subscription = event.data.object as Stripe.Subscription;

// After (SAFE):
const result = SubscriptionEventSchema.safeParse(event);
if (!result.success) {
  console.error("Payload validation failed:", result.error.issues);
  // Log to Sentry for monitoring
  return NextResponse.json({ error: "Invalid payload" }, { status: 400 });
}
const subscription = result.data.data.object;
```

4. ADD markEventProcessed() call AFTER successful processing (not before - allows retry on failure)

5. IMPROVE error handling:
- Log validation failures to Sentry with event.type for debugging
- Return specific error messages for different failure modes
- Keep returning 200 for successfully processed events (even if business logic has issues - prevent Stripe retries)

6. Structure the switch statement to validate event type first, then route to handlers with validated data.

IMPORTANT: Do NOT change the existing helper functions (handleSubscriptionUpdate, handleInvoicePayment, etc.) - only update how they're called with validated data.
  </action>
  <verify>
```bash
# TypeScript compiles
npx tsc --noEmit app/api/webhooks/stripe/route.ts

# No unsafe type assertions remain
grep -c "as Stripe\." app/api/webhooks/stripe/route.ts
# Should return 0
```
  </verify>
  <done>
Webhook handler validates all payloads with Zod before processing. No unsafe type assertions remain. Idempotency check prevents duplicate processing. Invalid payloads rejected with 400 status.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create security tests for webhook handler</name>
  <files>tests/api/webhooks/stripe/security.test.ts</files>
  <action>
Create comprehensive security tests:

**Signature Verification Tests:**
- Rejects request without stripe-signature header (400)
- Rejects request with invalid signature (400)
- Accepts request with valid signature

**Payload Validation Tests (SEC-03):**
- Rejects malformed subscription event (missing required fields)
- Rejects malformed invoice event (wrong field types)
- Accepts valid event with extra fields (passthrough working)
- Handles unknown event types gracefully

**Idempotency Tests:**
- First processing returns 200 and processes
- Duplicate event ID returns 200 but skips processing
- Processing failure allows retry (not marked as processed)

**Error Handling Tests:**
- Database errors during idempotency check don't block processing
- Validation errors are logged (mock Sentry capture)

Test setup:
- Mock Stripe's constructEvent to control signature verification
- Mock Supabase for database operations
- Use vi.spyOn for function mocking

Reference the research document "Testing Webhook Security" section for patterns.
  </action>
  <verify>
```bash
npm test -- tests/api/webhooks/stripe/security.test.ts
```
All security tests pass.
  </verify>
  <done>
Security test suite covers signature verification, payload validation, idempotency, and error handling. All tests pass, demonstrating SEC-01 and SEC-03 compliance.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. No unsafe type assertions in webhook handler:
```bash
grep "as Stripe\." app/api/webhooks/stripe/route.ts || echo "No unsafe casts - GOOD"
```

2. Zod validation is being used:
```bash
grep "safeParse" app/api/webhooks/stripe/route.ts
```

3. Idempotency check is present:
```bash
grep "isEventProcessed" app/api/webhooks/stripe/route.ts
```

4. All tests pass:
```bash
npm test -- tests/api/webhooks/stripe/security.test.ts
```

5. TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
</verification>

<success_criteria>
- SEC-01: Timing-safe comparison documented (Stripe SDK) and demonstrated (HMAC utility from Plan 01)
- SEC-03: All webhook payloads validated with Zod before type casting
- Idempotency tracking prevents duplicate event processing
- Security tests pass covering validation, signatures, and edge cases
- No TypeScript errors in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/02-webhook-security/02-02-SUMMARY.md`
</output>
