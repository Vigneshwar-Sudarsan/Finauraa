---
phase: 02-webhook-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/webhooks/stripe/schemas.ts
  - lib/webhook-security/hmac.ts
  - tests/lib/webhook-security/hmac.test.ts
autonomous: true

must_haves:
  truths:
    - "Zod schemas exist for all 10 Stripe webhook event types"
    - "Custom HMAC utility uses crypto.timingSafeEqual() for signature verification"
    - "HMAC utility handles buffer length mismatch safely"
  artifacts:
    - path: "app/api/webhooks/stripe/schemas.ts"
      provides: "Zod schemas for Stripe webhook events"
      exports: ["CheckoutSessionEventSchema", "SubscriptionEventSchema", "InvoiceEventSchema", "PaymentIntentEventSchema"]
    - path: "lib/webhook-security/hmac.ts"
      provides: "Timing-safe HMAC verification utility"
      exports: ["verifyWebhookSignature", "WebhookVerificationResult"]
    - path: "tests/lib/webhook-security/hmac.test.ts"
      provides: "Tests for HMAC verification"
      min_lines: 50
  key_links:
    - from: "lib/webhook-security/hmac.ts"
      to: "crypto.timingSafeEqual"
      via: "Node.js crypto module"
      pattern: "crypto\\.timingSafeEqual"
---

<objective>
Create Zod validation schemas for all Stripe webhook event types and implement a reusable HMAC verification utility using crypto.timingSafeEqual().

Purpose: Establish the foundational security utilities required for SEC-01 (timing-safe comparison) and SEC-03 (payload validation). The HMAC utility demonstrates direct crypto.timingSafeEqual() usage for future non-Stripe webhooks, while Zod schemas enable runtime validation before type casting.

Output: Two new utility modules (schemas.ts, hmac.ts) plus HMAC tests, ready for integration in Plan 02.
</objective>

<execution_context>
@/Users/Vignesh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Vignesh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-webhook-security/02-RESEARCH.md

# Current webhook implementation (shows all 10 event types to schema)
@app/api/webhooks/stripe/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas for Stripe webhook events</name>
  <files>app/api/webhooks/stripe/schemas.ts</files>
  <action>
Install Zod first:
```bash
npm install zod
```

Create Zod schemas for ALL 10 event types handled in route.ts:
1. checkout.session.completed
2. customer.subscription.created/updated
3. customer.subscription.deleted
4. customer.subscription.paused
5. customer.subscription.resumed
6. customer.subscription.trial_will_end
7. invoice.payment_succeeded/failed
8. invoice.upcoming
9. payment_intent.payment_failed

Schema design principles:
- Use `.passthrough()` on nested objects to allow additional Stripe fields without breaking
- Only validate fields actually accessed in handlers (from route.ts analysis):
  - Checkout: metadata.user_id, customer, subscription
  - Subscription: customer, status, cancel_at_period_end, created, trial_end, items.data[0].price.id, items.data[0].current_period_end
  - Invoice: customer, amount_paid, amount_due, currency, lines.data[0].description, hosted_invoice_url, invoice_pdf, period_start, period_end, last_finalization_error, payments.data[0].payment.payment_intent, subscription
  - PaymentIntent: customer, last_payment_error

Export type-inferred types alongside schemas for type-safe handler signatures.
Create a discriminated union schema that validates event.type and routes to correct schema.
  </action>
  <verify>
```bash
npx tsc --noEmit app/api/webhooks/stripe/schemas.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
Zod schemas exist for all 10 Stripe event types with exported TypeScript types. Schemas validate only fields accessed in handlers, using .passthrough() for flexibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create timing-safe HMAC verification utility with tests</name>
  <files>lib/webhook-security/hmac.ts, tests/lib/webhook-security/hmac.test.ts</files>
  <action>
Create lib/webhook-security/hmac.ts:
- Export `verifyWebhookSignature(payload: string, signature: string, secret: string, options?)` function
- Use `crypto.createHmac()` to compute expected signature
- Use `crypto.timingSafeEqual()` for constant-time comparison (SEC-01 requirement)
- Handle buffer length mismatch BEFORE calling timingSafeEqual (it throws if lengths differ)
- Return `{ verified: boolean, error?: string }` result type
- Support configurable algorithm (default: sha256)
- Add JSDoc comments explaining timing attack prevention

Create tests/lib/webhook-security/hmac.test.ts:
- Test valid signature verification
- Test invalid signature rejection
- Test buffer length mismatch handling (should return error, not throw)
- Test empty inputs (payload, signature, secret)
- Test different hash algorithms (sha256, sha512)

Reference the research document Pattern 2 for implementation details.
  </action>
  <verify>
```bash
npm test -- tests/lib/webhook-security/hmac.test.ts
```
All HMAC verification tests pass.
  </verify>
  <done>
HMAC utility exists at lib/webhook-security/hmac.ts using crypto.timingSafeEqual(). Tests cover valid signatures, invalid signatures, and edge cases. SEC-01 requirement (timing-safe comparison) is demonstrably implemented.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Zod schemas compile and export correctly:
```bash
npx tsc --noEmit app/api/webhooks/stripe/schemas.ts
```

2. HMAC tests all pass:
```bash
npm test -- tests/lib/webhook-security/hmac.test.ts
```

3. Both files exist with expected exports:
```bash
grep -l "export.*Schema" app/api/webhooks/stripe/schemas.ts
grep -l "timingSafeEqual" lib/webhook-security/hmac.ts
```
</verification>

<success_criteria>
- Zod installed and schemas created for all 10 Stripe event types
- HMAC utility uses crypto.timingSafeEqual() with proper buffer length handling
- All HMAC tests pass
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-webhook-security/02-01-SUMMARY.md`
</output>
