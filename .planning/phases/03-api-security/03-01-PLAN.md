---
phase: 03-api-security
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/tarabut/token-manager.ts
  - lib/tarabut/token-manager.test.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Token manager checks expiry before returning token"
    - "Tokens within 5-minute buffer window trigger refresh"
    - "Concurrent refresh requests for same user are serialized via mutex"
    - "Token refresh updates database with new expiry"
  artifacts:
    - path: "lib/tarabut/token-manager.ts"
      provides: "TarabutTokenManager class with getValidToken method"
      exports: ["TarabutTokenManager", "tokenManager"]
      min_lines: 80
    - path: "lib/tarabut/token-manager.test.ts"
      provides: "Unit tests for token manager"
      min_lines: 60
  key_links:
    - from: "lib/tarabut/token-manager.ts"
      to: "lib/tarabut/client.ts"
      via: "imports createTarabutClient"
      pattern: "import.*createTarabutClient"
    - from: "lib/tarabut/token-manager.ts"
      to: "async-mutex"
      via: "npm package import"
      pattern: "import.*Mutex.*async-mutex"
---

<objective>
Implement TarabutTokenManager with proactive token refresh and mutex-based concurrency control.

Purpose: Ensures SEC-02 compliance - Tarabut API calls check token expiry and refresh before requests, preventing 401 errors and race conditions.
Output: Token manager class with tests, async-mutex installed.
</objective>

<execution_context>
@/Users/Vignesh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Vignesh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-api-security/03-RESEARCH.md

@lib/tarabut/client.ts
@lib/database.types.ts
</context>

<feature>
  <name>TarabutTokenManager</name>
  <files>lib/tarabut/token-manager.ts, lib/tarabut/token-manager.test.ts</files>
  <behavior>
    Token manager provides getValidToken(userId, connection) method:

    Input scenarios:
    1. Token expires in 30 minutes -> return existing token, shouldUpdate: false
    2. Token expires in 3 minutes -> refresh token, return new token, shouldUpdate: true
    3. Token already expired -> refresh token, return new token, shouldUpdate: true
    4. Two concurrent calls for same user -> only one refresh occurs, both get same token
    5. Two concurrent calls for different users -> both can refresh in parallel

    Expected outputs:
    - { accessToken: string, shouldUpdate: boolean, expiresAt: Date }
    - shouldUpdate=true means caller must persist to database

    Test cases:
    - Token valid (30 min remaining): returns existing, shouldUpdate=false
    - Token near expiry (3 min): triggers refresh, shouldUpdate=true
    - Token expired: triggers refresh, shouldUpdate=true
    - Concurrent requests same user: only 1 refresh call made
    - Buffer time configurable: default 5 minutes
  </behavior>
  <implementation>
    1. Install async-mutex: npm install async-mutex
    2. Create TarabutTokenManager class with:
       - Map<string, Mutex> for per-user mutexes
       - bufferMinutes = 5 (configurable)
       - getValidToken(userId, connection) method
       - getUserMutex(userId) helper
    3. getValidToken logic:
       - Parse token_expires_at from connection
       - Calculate bufferTime = now + bufferMinutes
       - If expiresAt > bufferTime: return existing token
       - Otherwise: acquire mutex, double-check expiry, refresh if needed
    4. Export singleton: export const tokenManager = new TarabutTokenManager()
  </implementation>
</feature>

<verification>
npm run test -- lib/tarabut/token-manager.test.ts
All tests pass covering:
- Token validity checks
- Buffer window behavior
- Mutex serialization for concurrent requests
</verification>

<success_criteria>
- async-mutex installed in package.json
- TarabutTokenManager class exported from lib/tarabut/token-manager.ts
- getValidToken method returns { accessToken, shouldUpdate, expiresAt }
- Tests verify buffer window (5 min default) triggers refresh
- Tests verify mutex prevents concurrent refresh for same user
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-security/03-01-SUMMARY.md`
</output>
