---
phase: 03-api-security
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/api/finance/refresh/route.ts
  - app/api/tarabut/sync/route.ts
  - app/api/finance/refresh-balances/route.ts
  - app/api/cron/sync-banks/route.ts
autonomous: true

must_haves:
  truths:
    - "API routes check token expiry BEFORE calling Tarabut API"
    - "Expired tokens are refreshed automatically"
    - "Database is updated with new token after refresh"
    - "No 401 errors from expired tokens in normal flow"
  artifacts:
    - path: "app/api/finance/refresh/route.ts"
      provides: "Finance refresh with token manager"
      contains: "tokenManager.getValidToken"
    - path: "app/api/tarabut/sync/route.ts"
      provides: "Sync with token manager"
      contains: "tokenManager.getValidToken"
  key_links:
    - from: "app/api/finance/refresh/route.ts"
      to: "lib/tarabut/token-manager.ts"
      via: "import tokenManager"
      pattern: "import.*tokenManager.*token-manager"
    - from: "app/api/tarabut/sync/route.ts"
      to: "lib/tarabut/token-manager.ts"
      via: "import tokenManager"
      pattern: "import.*tokenManager.*token-manager"
---

<objective>
Integrate TarabutTokenManager into all API routes that call Tarabut APIs.

Purpose: Completes SEC-02 - all external API calls now check token expiry proactively.
Output: Updated API routes using token manager pattern.
</objective>

<execution_context>
@/Users/Vignesh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Vignesh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-api-security/03-01-SUMMARY.md

@lib/tarabut/token-manager.ts
@app/api/finance/refresh/route.ts
@app/api/tarabut/sync/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update finance refresh route</name>
  <files>app/api/finance/refresh/route.ts</files>
  <action>
    Replace the direct `client.getAccessToken(user.id)` call with token manager:

    1. Import tokenManager: `import { tokenManager } from "@/lib/tarabut/token-manager"`
    2. For each connection, use tokenManager.getValidToken:
       ```typescript
       const tokenResult = await tokenManager.getValidToken(user.id, {
         access_token: connection.access_token,
         token_expires_at: connection.token_expires_at
       });

       if (tokenResult.shouldUpdate) {
         await supabase
           .from("bank_connections")
           .update({
             access_token: tokenResult.accessToken,
             token_expires_at: tokenResult.expiresAt.toISOString(),
             updated_at: new Date().toISOString(),
           })
           .eq("id", connection.id);
       }

       const accessToken = tokenResult.accessToken;
       ```
    3. Remove the unconditional token fetch and update that happens now
    4. Keep the rest of the logic (accounts, balances, transactions) unchanged

    Why: Current code always fetches a new token, wasting API calls. Token manager only refreshes when needed.
  </action>
  <verify>npm run build (no type errors), manual inspection of route</verify>
  <done>finance/refresh route uses tokenManager.getValidToken, only updates DB when shouldUpdate=true</done>
</task>

<task type="auto">
  <name>Task 2: Update tarabut sync route</name>
  <files>app/api/tarabut/sync/route.ts</files>
  <action>
    Replace the expiry check and token refresh logic with token manager:

    1. Import tokenManager: `import { tokenManager } from "@/lib/tarabut/token-manager"`
    2. Remove the manual expiry check (lines 36-46 that check tokenExpiry < new Date())
    3. Replace with tokenManager.getValidToken:
       ```typescript
       const tokenResult = await tokenManager.getValidToken(user.id, {
         access_token: connection.access_token,
         token_expires_at: connection.token_expires_at
       });

       // Token manager handles expiry check with buffer - if truly expired and unrefreshable,
       // it will throw. The "expired" status update should only happen for connection issues,
       // not token expiry (tokens can be refreshed).

       if (tokenResult.shouldUpdate) {
         await supabase
           .from("bank_connections")
           .update({
             access_token: tokenResult.accessToken,
             token_expires_at: tokenResult.expiresAt.toISOString(),
           })
           .eq("id", connection.id);
       }

       const accessToken = tokenResult.accessToken;
       ```
    4. Remove the subsequent token fetch that happens unconditionally (lines 49-61)
    5. Keep rest of logic unchanged

    Why: Current code has partial expiry check (marks expired but still fetches new token). Token manager centralizes this logic.
  </action>
  <verify>npm run build (no type errors), manual inspection of route</verify>
  <done>tarabut/sync route uses tokenManager, removes manual expiry check</done>
</task>

<task type="auto">
  <name>Task 3: Update remaining Tarabut API routes</name>
  <files>
    app/api/finance/refresh-balances/route.ts
    app/api/cron/sync-banks/route.ts
  </files>
  <action>
    Apply the same pattern to other routes that call Tarabut APIs:

    For app/api/finance/refresh-balances/route.ts:
    1. Import tokenManager
    2. Replace getAccessToken call with tokenManager.getValidToken
    3. Update DB if shouldUpdate=true

    For app/api/cron/sync-banks/route.ts:
    1. Import tokenManager
    2. Replace getAccessToken calls with tokenManager.getValidToken
    3. Update DB if shouldUpdate=true

    Pattern to apply in each:
    ```typescript
    import { tokenManager } from "@/lib/tarabut/token-manager";

    // Replace: const tokenResponse = await client.getAccessToken(userId);
    // With:
    const tokenResult = await tokenManager.getValidToken(userId, {
      access_token: connection.access_token,
      token_expires_at: connection.token_expires_at
    });

    if (tokenResult.shouldUpdate) {
      // persist to database
    }

    const accessToken = tokenResult.accessToken;
    ```

    Note: Some routes may not have direct access to connection object. In those cases,
    fetch the connection first, then use token manager.
  </action>
  <verify>npm run build (no type errors)</verify>
  <done>All routes calling Tarabut APIs use tokenManager pattern</done>
</task>

</tasks>

<verification>
1. npm run build - no type errors
2. grep -r "getAccessToken" app/api --include="*.ts" | grep -v "token-manager"
   Should show minimal/no direct getAccessToken calls (only in token-manager itself)
3. grep -r "tokenManager.getValidToken" app/api --include="*.ts"
   Should show integration in finance/refresh, tarabut/sync, and other routes
</verification>

<success_criteria>
- All Tarabut API routes import and use tokenManager
- No direct client.getAccessToken() calls in API routes (only via token manager)
- Database updates only happen when tokenResult.shouldUpdate=true
- Build passes with no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-security/03-02-SUMMARY.md`
</output>
